此处函数已经十分混乱，但是角色太多，重构代价太大，因此先不管了